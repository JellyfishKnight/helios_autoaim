// created by liuhan on 2023/9/15
// Submodule of HeliosRobotSystem
// for more see document: https://swjtuhelios.feishu.cn/docx/MfCsdfRxkoYk3oxWaazcfUpTnih?from=from_copylink
#pragma once

#include <iostream>
#include <memory>

#include "rclcpp/rclcpp.hpp"
#include "tf2_ros/buffer.h"
#include "tf2_ros/transform_broadcaster.h"
#include "tf2_ros/transform_listener.h"

#include <image_transport/image_transport.hpp>
#include <image_transport/publisher.hpp>
#include <image_transport/subscriber_filter.hpp>


#include "helios_rs_interfaces/msg/send_data.hpp"
#include "helios_rs_interfaces/msg/receive_data.hpp"
#include "sensor_msgs/msg/image.hpp"
#include "sensor_msgs/msg/camera_info.hpp"
#include <visualization_msgs/msg/marker_array.hpp>
#include "helios_rs_interfaces/msg/debug_lights.hpp"
#include "helios_rs_interfaces/msg/debug_armors.hpp"


#include "TraditionalArmorDetector.hpp"
#include "TraditionalEnergyDetector.hpp"
#include "ArmorPredictor.hpp"
#include "EnergyPredictor.hpp"
#include "FireController.hpp"

// auto generated by ros2 generate_parameter_library
// https://github.com/PickNikRobotics/generate_parameter_library
#include "helios_autoaim_parameters.hpp"


namespace helios_cv {

enum Transition {
    NONE,
    CONFIGURE,
    ACTIVATE,
    DEACTIVATE,
    CLEANUP,
    SHUTDOWN,
};

enum State {
    UNCONFIGURED,
    INACTIVE,
    ACTIVE,
    FINALIZED,
    ERROR,
};

class HeliosAutoAim : public rclcpp::Node {
public:
    HeliosAutoAim(const rclcpp::NodeOptions& options);

    State on_configure();

    State on_activate();

    State on_deactivate();

    State on_cleanup();

    State on_shutdown();

    State on_error();
private:
    std::shared_ptr<BaseDetector> detector_;
    std::shared_ptr<BasePredictor> predictor_; 
    std::shared_ptr<BaseFireController> fire_controller_;
    
    rclcpp::Subscription<sensor_msgs::msg::Image>::SharedPtr image_sub_;
    rclcpp::Publisher<helios_rs_interfaces::msg::SendData>::SharedPtr target_data_pub_;

    // Visualization marker publisher
    visualization_msgs::msg::Marker armor_marker_;
    visualization_msgs::msg::Marker text_marker_;
    visualization_msgs::msg::MarkerArray marker_array_;
    rclcpp::Publisher<visualization_msgs::msg::MarkerArray>::SharedPtr marker_pub_;

    // Cam Info
    rclcpp::Subscription<sensor_msgs::msg::CameraInfo>::SharedPtr cam_info_sub_;
    sensor_msgs::msg::CameraInfo::SharedPtr cam_info_;

    // Debug information
    std::shared_ptr<image_transport::Publisher> binary_img_pub_;
    std::shared_ptr<image_transport::Publisher> number_img_pub_;
    std::shared_ptr<image_transport::Publisher> result_img_pub_;

    rclcpp::Node* this_node_;
    // Param listener
    std::shared_ptr<helios_autoaim::ParamListener> param_listener_;
    helios_autoaim::Params params_;

    Transition transition_;
    State state_;

    void init_markers();

    void publish_markers(helios_rs_interfaces::msg::Armors armors);

    /**
     * @brief image call back, main task function of this node
     * 
     * @param msg 
     */
    void image_callback(sensor_msgs::msg::Image::SharedPtr msg);

    rclcpp::Logger logger_ = rclcpp::get_logger("helios_autoaim");
};

} // namespace helios_cv

